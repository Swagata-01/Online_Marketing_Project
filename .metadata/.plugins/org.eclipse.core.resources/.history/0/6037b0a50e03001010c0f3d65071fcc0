package com.cts.entity;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.Date;

import com.cts.enums.UserRole;
import com.cts.exception.AgeValidationException;
import com.cts.exception.PhotoSizeValidationException;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Lob;
import jakarta.persistence.PrePersist;
import jakarta.persistence.PreUpdate;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Entity
@Table(name="Users")
@Builder
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name="UserID")
    private int userID;
    
    @Column(nullable = false)
    private String firstName;
    
    @Column(nullable = false)
    private String lastName;
    
    @Column(name="Email", nullable = false, unique = true)
    private String email;
    
    @Column(name="Password", nullable = false)
    private String password;
    
    @Column(name="NickName", nullable = false)
    private String nickName;
    
    @Column(name="Address", nullable = false)
    private String address;
    
    @Column(name="ContactNumber", nullable = false)
    private String contactNumber;
    
    @Lob
    @Column(name="Photo")
    private byte[] photo;
    
    @Column(name="DateOfBirth", nullable = false)
    private Date dateOfBirth;
    
    @Enumerated(EnumType.STRING)
    @Column(name="UserRole", nullable = false)
    @Builder.Default
    private UserRole userRole = UserRole.USER;
    
    @Column(name="EmailVerification", nullable = false)
    @Builder.Default
    private boolean emailVerification = true;
    
    @Column(name="IsActive", nullable = false)
    @Builder.Default
    private boolean isActive = true;
    
    @Column(name="AddedOn", nullable = false)
    @Builder.Default
    private LocalDateTime addedOn = LocalDateTime.now();
    
    @Column(name="UpdatedOn", nullable = false)
    @Builder.Default
    private LocalDateTime updatedOn = LocalDateTime.now();
    
    @PrePersist
    @PreUpdate
    private void validate() {
        validateAge();
        validatePhotoSize();
    }
    
    private void validateAge() {
        LocalDate birthDate = dateOfBirth.toInstant().atZone(ZoneId.systemDefault()).toLocalDate();
        int age = LocalDate.now().getYear() - birthDate.getYear();
        if (age < 18) {
            throw new AgeValidationException("User must be at least 18 years old.");
        }
    }
    
    private void validatePhotoSize() {
        if (photo != null) {
            int photoSize = photo.length / 1024;
            if (photoSize < 10 || photoSize > 20) {
                throw new PhotoSizeValidationException("Photo size must be between 10KB and 20KB.");
            }
        }
    }
}